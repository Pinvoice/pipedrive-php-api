<?php

require ('vendor/autoload.php');

use Pinvoice\Pipedrive\API as PipedriveAPI;

class DealFieldsTest extends PHPUnit_Framework_TestCase {

	/**
	 * Set up and test Pipedrive API connection, and add some test data.
	 */
	public function setUp() {
		$this->pipedrive = new PipedriveAPI(getenv('TOKEN'));

		if (!$this->pipedrive->isAuthenticated()) {
			$this->markTestSkipped('Cannot authenticate with Pipedrive.');
		}

		// Test data: Deal Fields (standard ones and two custom ones) and a Deal with custom DealField values.
		$this->dealfields = unserialize('a:23:{i:0;O:8:"stdClass":16:{s:2:"id";i:12437;s:3:"key";s:5:"title";s:4:"name";s:5:"Title";s:8:"order_nr";i:1;s:13:"picklist_data";N;s:10:"field_type";s:7:"varchar";s:8:"add_time";s:19:"2014-10-02 14:27:14";s:11:"update_time";s:19:"2014-10-02 14:27:02";s:11:"active_flag";b:1;s:9:"edit_flag";b:0;s:18:"index_visible_flag";b:1;s:20:"details_visible_flag";b:0;s:16:"add_visible_flag";b:0;s:17:"bulk_edit_allowed";b:1;s:9:"use_field";s:2:"id";s:4:"link";s:11:"/deal/view/";}i:1;O:8:"stdClass":14:{s:2:"id";i:12438;s:3:"key";s:7:"user_id";s:4:"name";s:5:"Owner";s:8:"order_nr";i:2;s:13:"picklist_data";N;s:10:"field_type";s:4:"user";s:8:"add_time";s:19:"2014-10-02 14:27:14";s:11:"update_time";s:19:"2014-10-02 14:27:02";s:11:"active_flag";b:1;s:9:"edit_flag";b:0;s:18:"index_visible_flag";b:1;s:20:"details_visible_flag";b:1;s:16:"add_visible_flag";b:0;s:17:"bulk_edit_allowed";b:1;}i:2;O:8:"stdClass":14:{s:2:"id";i:12439;s:3:"key";s:5:"value";s:4:"name";s:5:"Value";s:8:"order_nr";i:3;s:13:"picklist_data";N;s:10:"field_type";s:8:"monetary";s:8:"add_time";s:19:"2014-10-02 14:27:14";s:11:"update_time";s:19:"2014-10-02 14:27:02";s:11:"active_flag";b:1;s:9:"edit_flag";b:0;s:18:"index_visible_flag";b:1;s:20:"details_visible_flag";b:0;s:16:"add_visible_flag";b:0;s:17:"bulk_edit_allowed";b:1;}i:3;O:8:"stdClass":7:{s:2:"id";N;s:3:"key";s:8:"currency";s:4:"name";s:8:"Currency";s:10:"field_type";s:7:"varchar";s:9:"edit_flag";b:0;s:11:"active_flag";b:1;s:11:"is_subfield";b:1;}i:4;O:8:"stdClass":14:{s:2:"id";i:12440;s:3:"key";s:6:"org_id";s:4:"name";s:12:"Organization";s:8:"order_nr";i:4;s:13:"picklist_data";N;s:10:"field_type";s:3:"org";s:8:"add_time";s:19:"2014-10-02 14:27:14";s:11:"update_time";s:19:"2014-10-02 14:27:02";s:11:"active_flag";b:1;s:9:"edit_flag";b:0;s:18:"index_visible_flag";b:1;s:20:"details_visible_flag";b:1;s:16:"add_visible_flag";b:0;s:17:"bulk_edit_allowed";b:1;}i:5;O:8:"stdClass":14:{s:2:"id";i:12441;s:3:"key";s:8:"pipeline";s:4:"name";s:8:"Pipeline";s:8:"order_nr";i:5;s:13:"picklist_data";N;s:10:"field_type";s:6:"double";s:8:"add_time";s:19:"2014-10-02 14:27:14";s:11:"update_time";s:19:"2014-10-02 14:27:02";s:11:"active_flag";b:1;s:9:"edit_flag";b:0;s:18:"index_visible_flag";b:1;s:20:"details_visible_flag";b:0;s:16:"add_visible_flag";b:0;s:17:"bulk_edit_allowed";b:0;}i:6;O:8:"stdClass":14:{s:2:"id";i:12442;s:3:"key";s:9:"person_id";s:4:"name";s:14:"Contact person";s:8:"order_nr";i:6;s:13:"picklist_data";N;s:10:"field_type";s:6:"people";s:8:"add_time";s:19:"2014-10-02 14:27:14";s:11:"update_time";s:19:"2014-10-02 14:27:02";s:11:"active_flag";b:1;s:9:"edit_flag";b:0;s:18:"index_visible_flag";b:1;s:20:"details_visible_flag";b:1;s:16:"add_visible_flag";b:0;s:17:"bulk_edit_allowed";b:1;}i:7;O:8:"stdClass":15:{s:2:"id";i:12443;s:3:"key";s:8:"stage_id";s:4:"name";s:5:"Stage";s:8:"order_nr";i:7;s:13:"picklist_data";N;s:10:"field_type";s:5:"stage";s:8:"add_time";s:19:"2014-10-02 14:27:14";s:11:"update_time";s:19:"2014-10-02 14:27:02";s:11:"active_flag";b:1;s:9:"edit_flag";b:0;s:18:"index_visible_flag";b:1;s:20:"details_visible_flag";b:0;s:16:"add_visible_flag";b:0;s:17:"bulk_edit_allowed";b:1;s:9:"use_field";s:5:"stage";}i:8;O:8:"stdClass":14:{s:2:"id";i:12444;s:3:"key";s:6:"status";s:4:"name";s:6:"Status";s:8:"order_nr";i:8;s:10:"field_type";s:6:"status";s:8:"add_time";s:19:"2014-10-02 14:27:14";s:11:"update_time";s:19:"2014-10-02 14:27:02";s:11:"active_flag";b:1;s:9:"edit_flag";b:0;s:18:"index_visible_flag";b:1;s:20:"details_visible_flag";b:0;s:16:"add_visible_flag";b:0;s:17:"bulk_edit_allowed";b:1;s:7:"options";a:4:{i:0;O:8:"stdClass":2:{s:2:"id";s:4:"open";s:5:"label";s:4:"Open";}i:1;O:8:"stdClass":2:{s:2:"id";s:4:"lost";s:5:"label";s:4:"Lost";}i:2;O:8:"stdClass":2:{s:2:"id";s:3:"won";s:5:"label";s:3:"Won";}i:3;O:8:"stdClass":2:{s:2:"id";s:7:"deleted";s:5:"label";s:7:"Deleted";}}}i:9;O:8:"stdClass":14:{s:2:"id";i:12445;s:3:"key";s:8:"add_time";s:4:"name";s:12:"Deal created";s:8:"order_nr";i:9;s:13:"picklist_data";N;s:10:"field_type";s:4:"date";s:8:"add_time";s:19:"2014-10-02 14:27:14";s:11:"update_time";s:19:"2014-10-02 14:27:02";s:11:"active_flag";b:1;s:9:"edit_flag";b:0;s:18:"index_visible_flag";b:1;s:20:"details_visible_flag";b:0;s:16:"add_visible_flag";b:0;s:17:"bulk_edit_allowed";b:0;}i:10;O:8:"stdClass":14:{s:2:"id";i:12446;s:3:"key";s:11:"update_time";s:4:"name";s:11:"Update time";s:8:"order_nr";i:10;s:13:"picklist_data";N;s:10:"field_type";s:4:"date";s:8:"add_time";s:19:"2014-10-02 14:27:14";s:11:"update_time";s:19:"2014-10-02 14:27:02";s:11:"active_flag";b:1;s:9:"edit_flag";b:0;s:18:"index_visible_flag";b:1;s:20:"details_visible_flag";b:0;s:16:"add_visible_flag";b:0;s:17:"bulk_edit_allowed";b:0;}i:11;O:8:"stdClass":14:{s:2:"id";i:12447;s:3:"key";s:17:"stage_change_time";s:4:"name";s:17:"Last stage change";s:8:"order_nr";i:11;s:13:"picklist_data";N;s:10:"field_type";s:4:"date";s:8:"add_time";s:19:"2014-10-02 14:27:14";s:11:"update_time";s:19:"2014-10-02 14:27:02";s:11:"active_flag";b:1;s:9:"edit_flag";b:0;s:18:"index_visible_flag";b:1;s:20:"details_visible_flag";b:0;s:16:"add_visible_flag";b:0;s:17:"bulk_edit_allowed";b:0;}i:12;O:8:"stdClass":14:{s:2:"id";i:12448;s:3:"key";s:18:"next_activity_date";s:4:"name";s:18:"Next activity date";s:8:"order_nr";i:12;s:13:"picklist_data";N;s:10:"field_type";s:4:"date";s:8:"add_time";s:19:"2014-10-02 14:27:14";s:11:"update_time";s:19:"2014-10-02 14:27:02";s:11:"active_flag";b:1;s:9:"edit_flag";b:0;s:18:"index_visible_flag";b:1;s:20:"details_visible_flag";b:0;s:16:"add_visible_flag";b:0;s:17:"bulk_edit_allowed";b:0;}i:13;O:8:"stdClass":14:{s:2:"id";i:12449;s:3:"key";s:18:"last_activity_date";s:4:"name";s:18:"Last activity date";s:8:"order_nr";i:13;s:13:"picklist_data";N;s:10:"field_type";s:4:"date";s:8:"add_time";s:19:"2014-10-02 14:27:14";s:11:"update_time";s:19:"2014-10-02 14:27:02";s:11:"active_flag";b:1;s:9:"edit_flag";b:0;s:18:"index_visible_flag";b:1;s:20:"details_visible_flag";b:0;s:16:"add_visible_flag";b:0;s:17:"bulk_edit_allowed";b:0;}i:14;O:8:"stdClass":14:{s:2:"id";i:12450;s:3:"key";s:8:"won_time";s:4:"name";s:8:"Won time";s:8:"order_nr";i:14;s:13:"picklist_data";N;s:10:"field_type";s:4:"date";s:8:"add_time";s:19:"2014-10-02 14:27:14";s:11:"update_time";s:19:"2014-10-02 14:27:02";s:11:"active_flag";b:1;s:9:"edit_flag";b:0;s:18:"index_visible_flag";b:1;s:20:"details_visible_flag";b:0;s:16:"add_visible_flag";b:0;s:17:"bulk_edit_allowed";b:0;}i:15;O:8:"stdClass":14:{s:2:"id";i:12451;s:3:"key";s:9:"lost_time";s:4:"name";s:9:"Lost time";s:8:"order_nr";i:15;s:13:"picklist_data";N;s:10:"field_type";s:4:"date";s:8:"add_time";s:19:"2014-10-02 14:27:14";s:11:"update_time";s:19:"2014-10-02 14:27:02";s:11:"active_flag";b:1;s:9:"edit_flag";b:0;s:18:"index_visible_flag";b:1;s:20:"details_visible_flag";b:0;s:16:"add_visible_flag";b:0;s:17:"bulk_edit_allowed";b:0;}i:16;O:8:"stdClass":14:{s:2:"id";i:12452;s:3:"key";s:10:"close_time";s:4:"name";s:14:"Deal closed on";s:8:"order_nr";i:16;s:13:"picklist_data";N;s:10:"field_type";s:4:"date";s:8:"add_time";s:19:"2014-10-02 14:27:14";s:11:"update_time";s:19:"2014-10-02 14:27:02";s:11:"active_flag";b:1;s:9:"edit_flag";b:0;s:18:"index_visible_flag";b:1;s:20:"details_visible_flag";b:0;s:16:"add_visible_flag";b:0;s:17:"bulk_edit_allowed";b:0;}i:17;O:8:"stdClass":14:{s:2:"id";i:12453;s:3:"key";s:11:"lost_reason";s:4:"name";s:11:"Lost reason";s:8:"order_nr";i:17;s:13:"picklist_data";N;s:10:"field_type";s:12:"varchar_auto";s:8:"add_time";s:19:"2014-10-02 14:27:15";s:11:"update_time";s:19:"2014-10-02 14:27:02";s:11:"active_flag";b:1;s:9:"edit_flag";b:0;s:18:"index_visible_flag";b:1;s:20:"details_visible_flag";b:0;s:16:"add_visible_flag";b:0;s:17:"bulk_edit_allowed";b:1;}i:18;O:8:"stdClass":14:{s:2:"id";i:12454;s:3:"key";s:10:"visible_to";s:4:"name";s:10:"Visible to";s:8:"order_nr";i:18;s:10:"field_type";s:10:"visible_to";s:8:"add_time";s:19:"2014-10-02 14:27:15";s:11:"update_time";s:19:"2014-10-02 14:27:02";s:11:"active_flag";b:1;s:9:"edit_flag";b:0;s:18:"index_visible_flag";b:1;s:20:"details_visible_flag";b:1;s:16:"add_visible_flag";b:0;s:17:"bulk_edit_allowed";b:1;s:7:"options";a:2:{i:0;O:8:"stdClass":2:{s:2:"id";i:1;s:5:"label";s:17:"Owner & followers";}i:1;O:8:"stdClass":2:{s:2:"id";i:3;s:5:"label";s:14:"Entire company";}}}i:19;O:8:"stdClass":14:{s:2:"id";i:12455;s:3:"key";s:2:"id";s:4:"name";s:2:"ID";s:8:"order_nr";i:19;s:13:"picklist_data";N;s:10:"field_type";s:3:"int";s:8:"add_time";s:19:"2014-10-02 14:27:15";s:11:"update_time";s:19:"2014-10-02 14:27:02";s:11:"active_flag";b:1;s:9:"edit_flag";b:0;s:18:"index_visible_flag";b:1;s:20:"details_visible_flag";b:0;s:16:"add_visible_flag";b:0;s:17:"bulk_edit_allowed";b:0;}i:20;O:8:"stdClass":13:{s:2:"id";i:12456;s:3:"key";s:19:"expected_close_date";s:4:"name";s:19:"Expected close date";s:8:"order_nr";i:20;s:10:"field_type";s:4:"date";s:8:"add_time";s:19:"2014-10-02 14:27:15";s:11:"update_time";s:19:"2014-10-02 14:27:02";s:11:"active_flag";b:1;s:9:"edit_flag";b:0;s:18:"index_visible_flag";b:1;s:20:"details_visible_flag";b:1;s:16:"add_visible_flag";b:1;s:17:"bulk_edit_allowed";b:1;}i:21;O:8:"stdClass":13:{s:2:"id";i:12457;s:3:"key";s:40:"109204dc0283d5ced6c0438f8b7a220ecac9238d";s:4:"name";s:4:"Test";s:8:"order_nr";i:21;s:10:"field_type";s:6:"double";s:8:"add_time";s:19:"2014-11-03 20:12:59";s:11:"update_time";s:19:"2014-11-03 20:12:59";s:11:"active_flag";b:1;s:9:"edit_flag";b:1;s:18:"index_visible_flag";b:1;s:20:"details_visible_flag";b:1;s:16:"add_visible_flag";b:0;s:17:"bulk_edit_allowed";b:1;}i:22;O:8:"stdClass":13:{s:2:"id";i:12458;s:3:"key";s:40:"bfdb2c71c068b8d53a37baec0067924f3b9bdd2c";s:4:"name";s:4:"Blab";s:8:"order_nr";i:22;s:10:"field_type";s:7:"varchar";s:8:"add_time";s:19:"2014-11-04 17:10:02";s:11:"update_time";s:19:"2014-11-04 17:10:02";s:11:"active_flag";b:1;s:9:"edit_flag";b:1;s:18:"index_visible_flag";b:1;s:20:"details_visible_flag";b:1;s:16:"add_visible_flag";b:0;s:17:"bulk_edit_allowed";b:1;}}');
		$this->deal = unserialize('O:8:"stdClass":49:{s:2:"id";i:1;s:7:"user_id";O:8:"stdClass":5:{s:2:"id";i:347268;s:5:"value";i:347268;s:4:"name";s:15:"Melvin Lammerts";s:5:"email";s:20:"melvinl141@gmail.com";s:7:"has_pic";b:1;}s:9:"person_id";O:8:"stdClass":4:{s:5:"value";i:1;s:4:"name";s:7:"Foo Bar";s:5:"email";N;s:5:"phone";N;}s:6:"org_id";N;s:8:"stage_id";i:1;s:5:"title";s:13:"Pinvoice deal";s:5:"value";i:100;s:8:"currency";s:3:"EUR";s:8:"add_time";s:19:"2014-10-16 13:17:36";s:11:"update_time";s:19:"2014-11-10 14:02:13";s:17:"stage_change_time";s:19:"2014-10-16 13:17:36";s:6:"active";b:1;s:7:"deleted";b:0;s:6:"status";s:4:"open";s:18:"next_activity_date";N;s:18:"next_activity_time";N;s:16:"next_activity_id";N;s:16:"last_activity_id";N;s:18:"last_activity_date";N;s:11:"lost_reason";N;s:10:"visible_to";s:1:"3";s:10:"close_time";N;s:11:"pipeline_id";i:1;s:8:"won_time";N;s:9:"lost_time";N;s:14:"products_count";N;s:11:"files_count";N;s:11:"notes_count";i:0;s:20:"email_messages_count";N;s:16:"activities_count";N;s:23:"undone_activities_count";N;s:19:"expected_close_date";N;s:40:"109204dc0283d5ced6c0438f8b7a220ecac9238d";i:1232432;s:40:"bfdb2c71c068b8d53a37baec0067924f3b9bdd2c";N;s:14:"stage_order_nr";i:1;s:11:"person_name";s:7:"Foo Bar";s:8:"org_name";N;s:21:"next_activity_subject";N;s:18:"next_activity_type";N;s:22:"next_activity_duration";N;s:18:"next_activity_note";N;s:15:"formatted_value";s:8:"€ 100";s:14:"weighted_value";i:100;s:24:"formatted_weighted_value";s:8:"€ 100";s:11:"rotten_time";N;s:10:"owner_name";s:15:"Melvin Lammerts";s:8:"cc_email";s:30:"1.239005@dropbox.pipedrive.com";s:10:"org_hidden";b:0;s:13:"person_hidden";b:0;}');
	}

	/**
	 * Get current DealFields. Pass if no exception thrown by APIObject's safeReturn().
	 */
	public function testCanGetDealFields() {
		$this->pipedrive->dealfields->getDealFields();
	}

	/**
	 * Get information about Deal Field by key.
	 * Compare name to string ("Test") to verify.
	 */
	public function testCanGetDealFieldByKey() {
		$dealfield = $this->pipedrive->dealfields->getDealFieldByKey(
			'109204dc0283d5ced6c0438f8b7a220ecac9238d',
			$this->dealfields
		);
		$this->assertEquals($dealfield->name, 'Test');
	}

	/**
	 * Try to translate DealFields key to it's value in a Deal.
	 * 109204dc0283d5ced6c0438f8b7a220ecac9238d -> Test.
	 */
	public function testCanTranslateDealFieldKeys() {
		// Before translation
		$this->assertEquals($this->deal->{'109204dc0283d5ced6c0438f8b7a220ecac9238d'}, 1232432);

		// Translate keys
		$this->pipedrive->dealfields->translateDealFieldKeys($this->deal, $this->dealfields);

		// After translation
		$this->assertEquals($this->deal->Test, 1232432);
	}

}